<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Detail Pengeluaran</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{
    margin:0;
    font-family:Inter,sans-serif;
    background:#f1f5f9;
}
input, select, textarea, button{box-sizing:border-box}

/* HEADER */
.header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:18px 20px;
}
.header-left{display:flex;align-items:center;gap:12px}
.back{font-size:22px;cursor:pointer}
.header h2{margin:0;font-size:24px}
.download-btn{
    background:#22c55e;color:#fff;border:none;
    padding:8px 14px;border-radius:12px;
    font-size:14px;font-weight:600;cursor:pointer
}

/* CONTAINER */
.container{padding:20px;max-width:560px;margin:auto}

/* SUMMARY */
.summary{
    background:#fff;border-radius:22px;padding:20px;
    box-shadow:0 8px 24px rgba(0,0,0,.08);
    margin-bottom:22px
}
.summary-row{display:flex;justify-content:space-between;margin-bottom:10px;font-size:17px}
.summary-row.in strong{color:#16a34a}
.summary-row.out strong{color:#dc2626}
.summary-row.total{font-size:18px;margin-top:12px}

/* INPUT */
.input-card{
    background:#fff;border-radius:22px;padding:22px;
    box-shadow:0 8px 24px rgba(0,0,0,.08);
    margin-bottom:20px
}
.row{display:flex;gap:12px;margin-bottom:14px}
.row input,.row select{
    flex:1;height:50px;padding:0 14px;
    border-radius:14px;border:1px solid #d1d5db;
    font-size:16px
}
.input-card input{
    width:100%;height:52px;padding:0 16px;
    border-radius:14px;border:1px solid #d1d5db;
    margin-bottom:14px;font-size:16px
}
.add-btn{
    width:100%;height:52px;border:none;
    border-radius:14px;background:#22c55e;
    color:white;font-weight:600;font-size:16px
}
.toggle{text-align:center;font-size:15px;color:#2563eb;cursor:pointer;margin-bottom:14px}

/* LIST */
.list{display:flex;flex-direction:column;gap:16px}
.item{
    background:#fff;border-radius:18px;
    padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.08);
    display:flex;justify-content:space-between
}
.item.in{border-left:6px solid #22c55e}
.item.out{border-left:6px solid #ef4444}
.item h4{margin:0 0 6px;font-size:18px}
.item small{color:#64748b;font-size:14px}
.amount{font-weight:600;font-size:17px;text-align:right}
.amount.in{color:#16a34a}
.amount.out{color:#dc2626}

/* MODAL */
.modal{
    position:fixed;inset:0;padding:20px;
    background:rgba(0,0,0,.45);
    backdrop-filter:blur(6px);
    display:none;align-items:center;justify-content:center;
    z-index:100
}
.modal.show{display:flex}
.modal-box{
    background:#fff;border-radius:22px;
    padding:22px;width:100%;max-width:360px
}
.modal-box input,.modal-box select{
    width:100%;height:48px;
    border-radius:14px;border:1px solid #d1d5db;
    padding:0 14px;font-size:16px;margin-bottom:12px
}
.modal-actions{display:flex;gap:12px;margin-top:14px}
.modal-actions button{
    flex:1;height:48px;border:none;
    border-radius:14px;font-weight:600
}
.btn-cancel{background:#e5e7eb}
.btn-save{background:#22c55e;color:white}

/* TOAST */
.toast{
    position:fixed;top:-80px;left:50%;
    transform:translateX(-50%);
    background:#111827;color:white;
    padding:14px 22px;border-radius:16px;
    font-weight:600;transition:.4s;z-index:200
}
.toast.show{top:25px}
</style>
</head>

<body>

<div class="header">
  <div class="header-left">
    <div class="back" onclick="history.back()">←</div>
    <h2 id="pageTitle">Data</h2>
  </div>
  <button class="download-btn" onclick="downloadData()">Unduh</button>
</div>

<div class="container">
  <div class="summary">
    <div class="summary-row in"><span>Pemasukan</span><strong id="totalIn">Rp 0</strong></div>
    <div class="summary-row out"><span>Pengeluaran</span><strong id="totalOut">Rp 0</strong></div>
    <div class="summary-row total"><span>Saldo</span><strong id="saldo">Rp 0</strong></div>
  </div>

  <div class="toggle" onclick="toggleInput()">Tampilkan / Sembunyikan Input</div>

  <div id="inputCard" class="input-card">
    <div class="row">
      <input type="date" id="dateInput">
      <select id="typeInput">
        <option value="out">Pengeluaran</option>
        <option value="in">Pemasukan</option>
      </select>
    </div>

    <!-- INPUT NAMA (AUTO KAPITAL) -->
    <input
      id="nameInput"
      placeholder="Nama"
      autocapitalize="words"
      inputmode="text"
    >

    <!-- INPUT NOMINAL -->
    <input
      id="amountInput"
      type="number"
      placeholder="Nominal"
      inputmode="numeric"
    >

    <button class="add-btn" onclick="addItem()">Tambah</button>
  </div>

  <div id="list" class="list"></div>
</div>

<!-- MODAL DOWNLOAD -->
<div id="downloadModal" class="modal">
  <div class="modal-box">
    <h3>Unduh Data</h3>
    <input id="fileNameInput" placeholder="Nama file">
    <select id="fileTypeInput">
      <option value="txt">TXT (.txt)</option>
      <option value="xlsx">Excel (.xlsx)</option>
    </select>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeDownload()">Batal</button>
      <button class="btn-save" onclick="confirmDownload()">Unduh</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
import {
 auth, db, onAuthStateChanged,
 collection, addDoc, getDocs,
 doc, getDoc
} from "./firebase.js";

const params=new URLSearchParams(location.search);
const eventId=params.get("id");
dateInput.value=new Date().toISOString().split("T")[0];

let cachedItems=[];

function formatRp(n){
 return "Rp "+n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,".");
}

onAuthStateChanged(auth,async user=>{
 if(!user) return location.href="index.html";
 const snap=await getDoc(doc(db,"events",user.uid,"list",eventId));
 pageTitle.textContent=snap.data().title;
 loadItems(user.uid);
});

async function loadItems(uid){
 list.innerHTML="";
 let tin=0,tout=0;
 const q=await getDocs(collection(db,"events",uid,"list",eventId,"items"));
 cachedItems=[];
 q.forEach(d=>cachedItems.push(d.data()));
 cachedItems.sort((a,b)=>a.created-b.created);

 cachedItems.forEach((d,i)=>{
  d.type==="in"?tin+=d.amount:tout+=d.amount;
  list.innerHTML+=`
  <div class="item ${d.type}">
    <div>
      <h4>${i+1}. ${d.name}</h4>
      <small>${d.date}</small>
    </div>
    <div>
      <div class="amount ${d.type}">
        ${d.type==="out"?"-":"+"} ${formatRp(d.amount)}
      </div>
    </div>
  </div>`;
 });

 totalIn.textContent=formatRp(tin);
 totalOut.textContent=formatRp(tout);
 saldo.textContent=formatRp(tin-tout);
}

window.addItem=async()=>{
 if(!nameInput.value||!amountInput.value) return toast("Lengkapi data");
 await addDoc(collection(db,"events",auth.currentUser.uid,"list",eventId,"items"),{
  name:nameInput.value,
  amount:+amountInput.value,
  date:dateInput.value,
  type:typeInput.value,
  created:Date.now()
 });
 nameInput.value="";
 amountInput.value="";
 nameInput.focus();
 loadItems(auth.currentUser.uid);
 toast("Data ditambahkan");
};

/* ===== UX ENTER FLOW ===== */

// Enter di Nama → ke Nominal
nameInput.addEventListener("keydown",e=>{
 if(e.key==="Enter"){
  e.preventDefault();
  amountInput.focus();
 }
});

// Enter di Nominal → simpan
amountInput.addEventListener("keydown",e=>{
 if(e.key==="Enter"){
  e.preventDefault();
  addItem();
 }
});

window.toggleInput=()=>inputCard.style.display=inputCard.style.display==="none"?"block":"none";

/* DOWNLOAD */
window.downloadData=()=>{
 fileNameInput.value=pageTitle.textContent;
 downloadModal.classList.add("show");
};
window.closeDownload=()=>downloadModal.classList.remove("show");

window.confirmDownload=()=>{
 const name=fileNameInput.value.trim();
 if(!name) return toast("Nama file wajib diisi");
 if(fileTypeInput.value==="txt") generateTXT(name);
 else generateXLSX(name);
 closeDownload();
 toast("File diunduh");
};

function generateTXT(name){
 let text=`${pageTitle.textContent}\n====================\n\n`;
 let saldo=0;
 cachedItems.forEach((d,i)=>{
  saldo+=(d.type==="out"?-d.amount:d.amount);
  text+=`${i+1}. ${d.name}\nTanggal : ${d.date}\nJenis   : ${d.type==="out"?"Pengeluaran":"Pemasukan"}\nNominal : ${formatRp(d.amount)}\n\n`;
 });
 text+=`Saldo Akhir: ${formatRp(saldo)}`;
 downloadBlob(text,`${name}.txt`,"text/plain");
}

function generateXLSX(name){
 const rows=[];
 let saldo=0,totalIn=0,totalOut=0;
 rows.push([pageTitle.textContent]);
 rows.push([]);
 rows.push(["No","Tgl","Keterangan","Pemasukan","Pengeluaran","Saldo"]);

 cachedItems.forEach((d,i)=>{
  let masuk="",keluar="";
  if(d.type==="in"){masuk=d.amount;saldo+=d.amount;totalIn+=d.amount}
  else{keluar=d.amount;saldo-=d.amount;totalOut+=d.amount}
  rows.push([i+1,d.date,d.name,masuk,keluar,saldo]);
 });

 rows.push([]);
 rows.push(["Total Pemasukan","","",totalIn]);
 rows.push(["Total Pengeluaran","","",totalOut]);
 rows.push(["Saldo","","",saldo]);

 const ws=XLSX.utils.aoa_to_sheet(rows);
 ws["!merges"]=[{s:{r:0,c:0},e:{r:0,c:5}}];
 ws["A1"].s={alignment:{horizontal:"center"}};

 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"Laporan");
 XLSX.writeFile(wb,`${name}.xlsx`);
}

function downloadBlob(content,filename,type){
 const blob=new Blob([content],{type});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download=filename;
 a.click();
 URL.revokeObjectURL(a.href);
}

const toastEl=document.getElementById("toast");
function toast(m){
 toastEl.textContent=m;
 toastEl.classList.add("show");
 setTimeout(()=>toastEl.classList.remove("show"),2500);
}
</script>

</body>
</html>