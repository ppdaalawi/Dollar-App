<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Dashboard ‚Äì Dollar App</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
*{
  box-sizing:border-box;
  -webkit-tap-highlight-color:transparent;
}

body{
  margin:0;
  font-family:Inter,sans-serif;
  background:#f1f5f9;
}

/* HEADER */
.header{
  position:sticky;
  top:0;
  z-index:20;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:16px;
  background:#f1f5f9;
}
.header h2{margin:0;font-size:22px}
.logout{
  background:#ef4444;
  color:#fff;
  border:none;
  padding:10px 16px;
  border-radius:12px;
  font-size:15px;
}

/* CONTAINER */
.container{
  padding:16px;
  padding-bottom:90px;
}

/* GRID */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:14px;
}

/* CARD */
.card{
  background:#fff;
  border-radius:16px;
  padding:16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 6px 16px rgba(0,0,0,.08);
}
.card:active{transform:scale(.97)}
.card h3{margin:0;font-size:18px}
.card small{font-size:14px;color:#64748b}

.card-actions{
  display:flex;
  gap:10px;
}

.delete{
  font-size:22px;
  color:#ef4444;
  cursor:pointer;
}

.edit{
  font-size:20px;
  color:#2563eb;
  cursor:pointer;
}

/* ADD BTN */
.add-btn{
  position:fixed;
  bottom:20px;
  right:20px;
  width:60px;
  height:60px;
  border-radius:50%;
  background:#22c55e;
  color:white;
  font-size:34px;
  border:none;
  z-index:30;
}

/* MODAL */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  backdrop-filter:blur(6px);
  display:none;
  align-items:center;
  justify-content:center;
  padding:16px;
  z-index:100;
  animation:fadeIn .25s ease;
}

.modal{
  background:#fff;
  width:100%;
  max-width:360px;
  padding:22px;
  border-radius:18px;
  animation:scaleIn .25s ease;
}

@keyframes fadeIn{
  from{opacity:0}
  to{opacity:1}
}
@keyframes scaleIn{
  from{transform:scale(.9);opacity:0}
  to{transform:scale(1);opacity:1}
}

.modal h3{
  margin-top:0;
  font-size:20px;
}
.modal input{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:1px solid #d1d5db;
  margin-bottom:16px;
  font-size:16px;
  text-align:center;
}
.modal button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:12px;
  font-weight:600;
  font-size:16px;
}

.btn-green{background:#22c55e;color:white}
.btn-red{background:#ef4444;color:white;margin-top:10px}
.btn-grey{background:#e5e7eb;margin-top:10px}

/* TOAST */
.toast{
  position:fixed;
  top:-80px;
  left:50%;
  transform:translateX(-50%);
  background:#16a34a;
  color:white;
  padding:14px 20px;
  border-radius:16px;
  font-size:15px;
  transition:.35s;
  z-index:200;
}
.toast.show{top:20px}

/* LOADING */
.loading{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,.6);
  backdrop-filter:blur(4px);
  display:none;
  align-items:center;
  justify-content:center;
  font-weight:600;
  z-index:300;
}

@media(min-width:768px){
  .grid{grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
}
</style>
</head>

<body>

<div class="header">
  <h2>Data Pengeluaran</h2>
  <button class="logout" onclick="openLogout()">Logout</button>
</div>

<div class="container">
  <div id="list" class="grid"></div>
</div>

<button class="add-btn" onclick="openAdd()">+</button>

<!-- ADD -->
<div id="addModal" class="overlay" onclick="closeAdd()">
  <div class="modal" onclick="event.stopPropagation()">
    <h3>Tambah Event</h3>
    <input id="titleInput" placeholder="Nama event">
    <button id="saveBtn" class="btn-green" onclick="addData()">Simpan</button>
    <button class="btn-grey" onclick="closeAdd()">Batal</button>
  </div>
</div>

<!-- DELETE -->
<div id="deleteModal" class="overlay" onclick="closeDelete()">
  <div class="modal" onclick="event.stopPropagation()">
    <h3>Hapus data ini?</h3>

    <!-- TAMBAHAN -->
    <input id="confirmDeleteInput" placeholder="Ketik yes untuk hapus">

    <button class="btn-red" onclick="confirmDelete()">Hapus</button>
    <button class="btn-grey" onclick="closeDelete()">Batal</button>
  </div>
</div>

<!-- EDIT -->
<div id="editModal" class="overlay" onclick="closeEdit()">
  <div class="modal" onclick="event.stopPropagation()">
    <h3>Edit Nama Event</h3>
    <input id="editTitleInput" placeholder="Nama event baru">
    <button class="btn-green" onclick="confirmEdit()">Simpan</button>
    <button class="btn-grey" onclick="closeEdit()">Batal</button>
  </div>
</div>

<!-- LOGOUT -->
<div id="logoutModal" class="overlay" onclick="closeLogout()">
  <div class="modal" onclick="event.stopPropagation()">
    <h3>Keluar dari aplikasi?</h3>
    <button class="btn-red" onclick="confirmLogout()">Logout</button>
    <button class="btn-grey" onclick="closeLogout()">Batal</button>
  </div>
</div>

<div id="toast" class="toast"></div>
<div id="loading" class="loading">Loading...</div>

<script type="module">
import {
  auth, db, signOut, onAuthStateChanged,
  collection, addDoc, getDocs, deleteDoc, doc, updateDoc
} from "./firebase.js";

let deleteId=null;
let editId=null;
let allowExit=false;

/* AUTH */
onAuthStateChanged(auth,user=>{
  if(!user) location.href="index.html";
  loadData(user.uid);
});

/* BACK ANDROID */
history.pushState(null,"");
window.onpopstate=()=>{
  if(!allowExit){
    openLogout();
    history.pushState(null,"");
  }
};

/* LOAD */
async function loadData(uid){
  showLoad(true);
  list.innerHTML="";
  const snap=await getDocs(collection(db,"events",uid,"list"));
  snap.forEach(d=>{
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML=`
      <div>
        <h3>${d.data().title}</h3>
        <small>Tap untuk buka</small>
      </div>
      <div class="card-actions">
        <div class="edit">‚úèÔ∏è</div>
        <div class="delete">üóë</div>
      </div>
    `;
    c.onclick=()=>openData(d.id);

    c.querySelector(".delete").onclick=e=>{
      e.stopPropagation();
      openDelete(d.id);
    };

    c.querySelector(".edit").onclick=e=>{
      e.stopPropagation();
      openEdit(d.id,d.data().title);
    };

    list.appendChild(c);
  });
  showLoad(false);
}

/* ADD */
window.openAdd=()=>{
  addModal.style.display="flex";
  setTimeout(()=>titleInput.focus(),100);
};
window.closeAdd=()=>addModal.style.display="none";

titleInput.addEventListener("keydown",e=>{
  if(e.key==="Enter") addData();
});

window.addData=async()=>{
  const title=titleInput.value.trim();
  if(!title) return toast("Judul wajib diisi");

  saveBtn.disabled=true;
  showLoad(true);

  const col=collection(db,"events",auth.currentUser.uid,"list");
  const snap=await getDocs(col);

  for(const d of snap.docs){
    if(d.data().title.toLowerCase()===title.toLowerCase()){
      saveBtn.disabled=false;
      showLoad(false);
      return toast("Nama sudah ada ‚ùå");
    }
  }

  await addDoc(col,{title,created:Date.now()});
  titleInput.value="";
  closeAdd();
  loadData(auth.currentUser.uid);
  toast("Event ditambahkan ‚úÖ");
  saveBtn.disabled=false;
};

/* EDIT */
window.openEdit=(id,title)=>{
  editId=id;
  editTitleInput.value=title;
  editModal.style.display="flex";
  setTimeout(()=>editTitleInput.focus(),100);
};

window.closeEdit=()=>editModal.style.display="none";

window.confirmEdit=async()=>{
  const newTitle=editTitleInput.value.trim();
  if(!newTitle) return toast("Nama tidak boleh kosong");

  showLoad(true);
  await updateDoc(
    doc(db,"events",auth.currentUser.uid,"list",editId),
    { title:newTitle }
  );
  closeEdit();
  loadData(auth.currentUser.uid);
  toast("Nama event diperbarui ‚úèÔ∏è");
};

/* DELETE */
window.openDelete=id=>{
  deleteId=id;
  confirmDeleteInput.value="";   // TAMBAHAN
  deleteModal.style.display="flex";
};
window.closeDelete=()=>deleteModal.style.display="none";

window.confirmDelete=async()=>{
  if(confirmDeleteInput.value.trim().toLowerCase()!=="yes"){
    return toast("Ketik yes untuk menghapus ‚ùó");
  }

  showLoad(true);
  await deleteDoc(doc(db,"events",auth.currentUser.uid,"list",deleteId));
  closeDelete();
  loadData(auth.currentUser.uid);
  toast("Data dihapus");
};

/* LOGOUT */
window.openLogout=()=>logoutModal.style.display="flex";
window.closeLogout=()=>logoutModal.style.display="none";

window.confirmLogout=async()=>{
  allowExit=true;
  showLoad(true);
  await signOut(auth);
  location.href="index.html";
};

/* NAV */
window.openData=id=>location.href=`data.html?id=${id}`;

/* UI */
const toastEl=document.getElementById("toast");
const loadEl=document.getElementById("loading");

function toast(t){
  toastEl.textContent=t;
  toastEl.classList.add("show");
  setTimeout(()=>toastEl.classList.remove("show"),2200);
}
function showLoad(s){
  loadEl.style.display=s?"flex":"none";
}
</script>

</body>
</html>